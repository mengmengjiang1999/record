# week22-20240722-20240728

error: linking with `cc` failed: exit status: 1
  |
  = note: LC_ALL="C" PATH="/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/bin:/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/bin/self-contained:/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/bin:/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/bin/self-contained:/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/bin:/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/bin/self-contained:/usr/local/riscv64-linux-musl-cross/bin:/usr/local/riscv64-unknown-elf-gcc/bin:/home/mmj/.local/bin:/home/mmj/.vscode-server/cli/servers/Stable-5437499feb04f7a586f677b155b039bc2b3669eb/server/bin/remote-cli:/home/mmj/.local/bin:/home/mmj/bin:/usr/local/riscv64-linux-musl-cross/bin:/usr/local/riscv64-unknown-elf-gcc/bin:/home/mmj/.local/bin:/home/mmj/.cargo/bin:/home/mmj/.local/bin:/home/mmj/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/home/mmj/simics/ispm/:/home/mmj/simics/ispm/" VSLANG="1033" "cc" "-m64" "/tmp/rustcPMeB9D/symbols.o" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/deps/exercise_3-fa6dc3d132170959.exercise_3.58584b1450222e24-cgu.0.rcgu.o" "-Wl,--as-needed" "-L" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/deps" "-L" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/build/libafl_qemu-2552fcf021647304/out" "-L" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/build/capstone-sys-66e4cd56ccce949e/out" "-L" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/build/libafl_qemu_sys-44ed2838b329e7ab/out" "-L" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/build/libafl_targets-73d1f2481c2a072f/out" "-L" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/build/libafl_targets-73d1f2481c2a072f/out" "-L" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/build/libafl_targets-73d1f2481c2a072f/out" "-L" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/build/libafl_targets-73d1f2481c2a072f/out" "-L" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/build/libafl_targets-73d1f2481c2a072f/out" "-L" "/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib" "-Wl,-Bstatic" "/tmp/rustcPMeB9D/liblibafl_qemu-d5a2687fed012e08.rlib" "/tmp/rustcPMeB9D/libcapstone_sys-7627ac772c799e3e.rlib" "/tmp/rustcPMeB9D/liblibafl_qemu_sys-9a8ce06d6a78a56f.rlib" "/tmp/rustcPMeB9D/liblibafl_targets-f0127191c650f954.rlib" "/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-4d7d16bbf0636a40.rlib" "-Wl,-Bdynamic" "-lcapstone" "-lrt" "-lm" "-lglib-2.0" "-lgmodule-2.0" "-lgcc_s" "-lutil" "-lrt" "-lpthread" "-lm" "-ldl" "-lc" "-B/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/bin/gcc-ld" "-B/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/bin/gcc-ld" "-B/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/bin/gcc-ld" "-fuse-ld=lld" "-Wl,--eh-frame-hdr" "-Wl,-z,noexecstack" "-L" "/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib" "-L" "/home/mmj/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/x86_64-unknown-linux-gnu/lib/self-contained" "-o" "/home/mmj/Project/fuzzing/fuzzing-101-solutions/target/release/deps/exercise_3-fa6dc3d132170959" "-Wl,--gc-sections" "-pie" "-Wl,-z,relro,-z,now" "-Wl,-O1" "-nodefaultlibs" "-ldw"
  = note: rust-lld: error: unable to find library -ldw
          collect2: error: ld returned 1 exit status
          

error: could not compile `exercise-3` (bin "exercise-3") due to 1 previous error
mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3$ which libdw.dylib
mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3$ sudo apt install libdw1 libdw-dev
[sudo] password for mmj: 
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
libdw1 is already the newest version (0.186-1build1).
libdw1 set to manually installed.
The following NEW packages will be installed:
  libdw-dev
0 upgraded, 1 newly installed, 0 to remove and 3 not upgraded.
Need to get 327 kB of archives.
After this operation, 1,719 kB of additional disk space will be used.
Do you want to continue? [Y/n] Y
Get:1 http://mirrors.tuna.tsinghua.edu.cn/ubuntu jammy/main amd64 libdw-dev amd64 0.186-1build1 [327 kB]
Fetched 327 kB in 0s (13.8 MB/s)  
Selecting previously unselected package libdw-dev:amd64.
(Reading database ... 927896 files and directories currently installed.)
Preparing to unpack .../libdw-dev_0.186-1build1_amd64.deb ...
Unpacking libdw-dev:amd64 (0.186-1build1) ...
Setting up libdw-dev:amd64 (0.186-1build1) ...
mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3$ cargo build --release
warning: `/home/mmj/.cargo/config` is deprecated in favor of `config.toml`
note: if you need to support cargo 1.38 or earlier, you can symlink `config` to `config.toml`
warning: `/home/mmj/.cargo/config` is deprecated in favor of `config.toml`
note: if you need to support cargo 1.38 or earlier, you can symlink `config` to `config.toml`
warning: virtual workspace defaulting to `resolver = "1"` despite one or more workspace members being on edition 2021 which implies `resolver = "2"`
note: to keep the current resolver, specify `workspace.resolver = "1"` in the workspace root's manifest
note: to use the edition 2021 resolver, specify `workspace.resolver = "2"` in the workspace root's manifest
note: for more details see https://doc.rust-lang.org/cargo/reference/resolver.html#resolver-versions
   Compiling exercise-3 v0.1.0 (/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3)
    Finished `release` profile [optimized + debuginfo] target(s) in 35.49s
mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3$ 


发现提示了报错，某一个库找不到。其实我也不知道这个库叫什么名字，但是猜了一下应该是叫libdw.dylib，然后查了查随便安装了点包，就有这个库了（


mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3/tcpdump$ CC="/home/mmj/Project/AFLplusplus/afl-clang-lto"
mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3/tcpdump$ CXX="/home/mmj/Project/AFLplusplus/afl-clang-lto++"
mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3/tcpdump$ LLVM_CONFIG=llvm-config-18
mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3/tcpdump$ AFL_MAP_SIZE=86217
mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3/tcpdump$ AFL_USE_ASAN=1
mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3/tcpdump$ CFLAGS="-I/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/include/"
mmj@oslab-H170-PRO:~/Project/fuzzing/fuzzing-101-solutions/exercise-3/tcpdump$ LDFLAGS="-L/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/lib/"

./configure --enable-shared=no --prefix="/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/"


libpcap
CC="/home/mmj/Project/AFLplusplus/afl-clang-lto" CXX="/home/mmj/Project/AFLplusplus/afl-clang-lto++" LLVM_CONFIG=llvm-config-18 AFL_MAP_SIZE=86217 AFL_USE_ASAN=1 ./configure --enable-shared=no --prefix="/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/"


tcpdump
CC="/home/mmj/Project/AFLplusplus/afl-clang-lto" CXX="/home/mmj/Project/AFLplusplus/afl-clang-lto++" LLVM_CONFIG=llvm-config-18 AFL_MAP_SIZE=86217 AFL_USE_ASAN=1 CFLAGS="-I/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/include/  -fsanitize=address" CXXFLAGS="-I/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/include/  -fsanitize=address" LDFLAGS="-L/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/lib/  -fsanitize=address" ./configure --prefix="/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/"


---


[+] Instrumented 27944 locations (571 selects) without collisions (5194 collisions have been avoided) (non-hardened mode).
ld.lld: error: undefined symbol: __asan_init
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_ctor)
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_ctor.305)
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_ctor.323)
>>> referenced 21 more times

ld.lld: error: undefined symbol: __asan_version_mismatch_check_v8
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_ctor)
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_ctor.305)
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_ctor.323)
>>> referenced 21 more times

ld.lld: error: undefined symbol: __asan_register_globals
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_ctor)
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_ctor.305)
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_ctor.323)
>>> referenced 20 more times

ld.lld: error: undefined symbol: __asan_unregister_globals
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_dtor)
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_dtor.306)
>>> referenced by ld-temp.o
>>>               lto.tmp:(asan.module_dtor.324)
>>> referenced 20 more times

ld.lld: error: undefined symbol: __asan_report_load8
>>> referenced by pcap.c:166 (./pcap.c:166)
>>>               lto.tmp:(pcap_can_set_rfmon)
>>> referenced by pcap.c:205 (./pcap.c:205)
>>>               lto.tmp:(pcap_list_tstamp_types)
>>> referenced by pcap.c:238 (./pcap.c:238)
>>>               lto.tmp:(pcap_oneshot)
>>> referenced 2202 more times

ld.lld: error: undefined symbol: __asan_memcpy
>>> referenced by pcap.c:205 (./pcap.c:205)
>>>               lto.tmp:(pcap_list_tstamp_types)
>>> referenced by pcap.c:238 (./pcap.c:238)
>>>               lto.tmp:(pcap_oneshot)
>>> referenced by pcap.c:611 (./pcap.c:611)
>>>               lto.tmp:(pcap_create_common)
>>> referenced 73 more times

ld.lld: error: undefined symbol: __asan_report_store8
>>> referenced by pcap.c:198 (./pcap.c:198)
>>>               lto.tmp:(pcap_list_tstamp_types)
>>> referenced by pcap.c:196 (./pcap.c:196)
>>>               lto.tmp:(pcap_list_tstamp_types)
>>> referenced by pcap.c:239 (./pcap.c:239)
>>>               lto.tmp:(pcap_oneshot)
>>> referenced 1703 more times

ld.lld: error: undefined symbol: __asan_report_load4
>>> referenced by pcap.c:192 (./pcap.c:192)
>>>               lto.tmp:(pcap_list_tstamp_types)
>>> referenced by pcap.c:202 (./pcap.c:202)
>>>               lto.tmp:(pcap_list_tstamp_types)
>>> referenced by pcap.c:444 (./pcap.c:444)
>>>               lto.tmp:(pcap_create)
>>> referenced 2661 more times

ld.lld: error: undefined symbol: __asan_option_detect_stack_use_after_return
>>> referenced by pcap.c:387 (./pcap.c:387)
>>>               lto.tmp:(pcap_create)
>>> referenced by pcap-bt-linux.c:78 (./pcap-bt-linux.c:78)
>>>               lto.tmp:(bt_findalldevs)
>>> referenced by pcap-bt-linux.c:141 (./pcap-bt-linux.c:141)
>>>               lto.tmp:(bt_create)
>>> referenced 106 more times

ld.lld: error: undefined symbol: __asan_stack_malloc_0
>>> referenced by pcap.c:387 (./pcap.c:387)
>>>               lto.tmp:(pcap_create)
>>> referenced by pcap-bt-linux.c:141 (./pcap-bt-linux.c:141)
>>>               lto.tmp:(bt_create)
>>> referenced by pcap-canusb-linux.c:212 (./pcap-canusb-linux.c:212)
>>>               lto.tmp:(canusb_create)
>>> referenced 31 more times

ld.lld: error: undefined symbol: __asan_report_store4
>>> referenced by pcap.c:441 (./pcap.c:441)
>>>               lto.tmp:(pcap_create)
>>> referenced by pcap.c:602 (./pcap.c:602)
>>>               lto.tmp:(pcap_create_common)
>>> referenced by pcap.c:623 (./pcap.c:623)
>>>               lto.tmp:(pcap_create_common)
>>> referenced 2121 more times

ld.lld: error: undefined symbol: __asan_memset
>>> referenced by pcap.c:544 (./pcap.c:544)
>>>               lto.tmp:(pcap_create_common)
>>> referenced by pcap.c:592 (./pcap.c:592)
>>>               lto.tmp:(pcap_create_common)
>>> referenced by pcap.c:544 (./pcap.c:544)
>>>               lto.tmp:(pcap_open_offline_common)
>>> referenced 73 more times

ld.lld: error: undefined symbol: __asan_report_store_n
>>> referenced by pcap.c:596 (./pcap.c:596)
>>>               lto.tmp:(pcap_create_common)
>>> referenced by pcap.c:596 (./pcap.c:596)
>>>               lto.tmp:(pcap_create_common)
>>> referenced by pcap-bt-linux.c:248 (./pcap-bt-linux.c:248)
>>>               lto.tmp:(bt_activate)
>>> referenced 81 more times

ld.lld: error: undefined symbol: __asan_report_load1
>>> referenced by pcap.c:776 (./pcap.c:776)
>>>               lto.tmp:(pcap_activate)
>>> referenced by pcap.c:1111 (./pcap.c:1111)
>>>               lto.tmp:(pcap_strcasecmp)
>>> referenced by pcap.c:1111 (./pcap.c:1111)
>>>               lto.tmp:(pcap_strcasecmp)
>>> referenced 250 more times

ld.lld: error: undefined symbol: __asan_report_store1
>>> referenced by pcap.c:1909 (./pcap.c:1909)
>>>               lto.tmp:(pcap_do_addexit)
>>> referenced by pcap-canusb-linux.c:128 (./pcap-canusb-linux.c:128)
>>>               lto.tmp:(canusb_findalldevs)
>>> referenced by pcap-canusb-linux.c:174 (./pcap-canusb-linux.c:174)
>>>               lto.tmp:(canusb_activate)
>>> referenced 109 more times

ld.lld: error: undefined symbol: __asan_stack_malloc_2
>>> referenced by pcap-bt-linux.c:78 (./pcap-bt-linux.c:78)
>>>               lto.tmp:(bt_findalldevs)
>>> referenced by pcap-bt-linux.c:300 (./pcap-bt-linux.c:300)
>>>               lto.tmp:(bt_read_linux)
>>> referenced by pcap-bt-linux.c:379 (./pcap-bt-linux.c:379)
>>>               lto.tmp:(bt_stats_linux)
>>> referenced 19 more times

ld.lld: error: undefined symbol: __asan_report_load2
>>> referenced by pcap-bt-linux.c:119 (./pcap-bt-linux.c:119)
>>>               lto.tmp:(bt_findalldevs)
>>> referenced by pcap-bt-linux.c:116 (./pcap-bt-linux.c:116)
>>>               lto.tmp:(bt_findalldevs)
>>> referenced by pcap-bt-linux.c:116 (./pcap-bt-linux.c:116)
>>>               lto.tmp:(bt_findalldevs)
>>> referenced 146 more times

ld.lld: error: undefined symbol: __asan_report_store2
>>> referenced by pcap-bt-linux.c:104 (./pcap-bt-linux.c:104)
>>>               lto.tmp:(bt_findalldevs)
>>> referenced by pcap-bt-linux.c:257 (./pcap-bt-linux.c:257)
>>>               lto.tmp:(bt_activate)
>>> referenced by pcap-bt-linux.c:258 (./pcap-bt-linux.c:258)
>>>               lto.tmp:(bt_activate)
>>> referenced 72 more times

ld.lld: error: undefined symbol: __asan_stack_malloc_1
>>> referenced by pcap-bt-linux.c:184 (./pcap-bt-linux.c:184)
>>>               lto.tmp:(bt_activate)
>>> referenced by pcap-bt-monitor-linux.c:166 (./pcap-bt-monitor-linux.c:166)
>>>               lto.tmp:(bt_monitor_activate)
>>> referenced by pcap-canusb-linux.c:263 (./pcap-canusb-linux.c:263)
>>>               lto.tmp:(canusb_capture_thread)
>>> referenced 25 more times

ld.lld: error: undefined symbol: __asan_stack_malloc_3
>>> referenced by pcap-bt-monitor-linux.c:78 (./pcap-bt-monitor-linux.c:78)
>>>               lto.tmp:(bt_monitor_read)
>>> referenced by pcap-canusb-linux.c:91 (./pcap-canusb-linux.c:91)
>>>               lto.tmp:(canusb_findalldevs)
>>> referenced by pcap-canusb-linux.c:346 (./pcap-canusb-linux.c:346)
>>>               lto.tmp:(canusb_activate)
>>> referenced 5 more times

ld.lld: error: too many errors emitted, stopping now (use --error-limit=0 to see all errors)
clang: error: linker command failed with exit code 1 (use -v to see invocation)
make: *** [Makefile:374: tcpdump] Error 1

这个报错的含义应该是找不到ASAN相关的库。查找发现需要把CFLAG，CXXFLAG，LDFLAG都加上编译选项-fsanitize=address，也就是说


tcpdump
CC="/home/mmj/Project/AFLplusplus/afl-clang-lto" CXX="/home/mmj/Project/AFLplusplus/afl-clang-lto++" LLVM_CONFIG=llvm-config-18 AFL_MAP_SIZE=86217 AFL_USE_ASAN=1 CFLAGS="-I/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/include/  -fsanitize=address" CXXFLAGS="-I/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/include/  -fsanitize=address" LDFLAGS="-L/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/lib/  -fsanitize=address" ./configure --prefix="/home/mmj/Project/fuzzing/fuzzing-101-solutions/exercise-3/build/"


就可以了。


-----

clap从某个版本开始，multiple_values不能用了，而是需要用num_args=1..替代。

https://stackoverflow.com/questions/73240901/how-to-get-clap-to-process-a-single-argument-with-multiple-values-without-having


-----

cargo build --release

mkdir -p build/
cp ../target/release/exercise-3 build/
sudo setcap cap_sys_admin+epi build/exercise-3

AFL_MAP_SIZE=86217 ASAN_OPTIONS=abort_on_error=1 ./build/exercise-3 -i corpus/ -o solutions/ -c 0-3 -t ./build/sbin/tcpdump --args -vr @@


-----


还是跑不通。打算继续放弃（？）


其实我的目标只是掌握LibAFL的简单用法而已。从最简单的开始吧：fuzz一个用户程序


baby_fuzzer当触发崩溃之后就会立刻crash

baby_fuzzer_grimorine在触发崩溃之后不会立刻crash

